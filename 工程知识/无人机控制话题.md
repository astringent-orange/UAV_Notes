---
aliases:
  - 控制
tags:
  - MAVROS
  - 位置
  - 姿态
  - 服务
---
MAVROS对于四旋翼无人机的控制主要有12个变量 位置（x，y，z），姿态（roll，pitch，yaw），速度（vx，vy，vz），角速度（wx，wy，wz）

#### 位置控制
- 订阅
**话题：**`/mavros/local_position/pose`
**消息：**

- 发布 
**话题：**`/mavros/setpoint_position/local`
**消息：**

#### 姿态控制
- 订阅
**话题：**`/mavros/imu/data`
**消息：**`/sensor_msgs/Imu`（姿态/角速度反馈，四元数在 `orientation`）

- 发布
**话题：**`/mavros/setpoint_raw/attitude` 
**消息：**`mavros_msgs/AttitudeTarget`，可同时下发：四元数姿态 `orientation`、机体系角速度 `body_rate`、以及推力 `thrust`（0~1 归一化）；
```CPP
// 生成 AttitudeTarget（姿态 + 推力，忽略角速度）
static mavros_msgs::AttitudeTarget makeAttSp(double roll, double pitch, double yaw, double thrust){
    mavros_msgs::AttitudeTarget sp;
    sp.type_mask = (
        mavros_msgs::AttitudeTarget::IGNORE_ROLL_RATE |
        mavros_msgs::AttitudeTarget::IGNORE_PITCH_RATE |
        mavros_msgs::AttitudeTarget::IGNORE_YAW_RATE
    );
    tf2::Quaternion q;
    q.setRPY(roll, pitch, yaw); // ENU，单位：rad
    q.normalize();
    sp.orientation = tf2::toMsg(q);
    sp.thrust = std::max(0.0, std::min(1.0, thrust)); // 0~1
    return sp;
}
```
其中tf2是ros用于数学变换的功能包，此处将弧度制的欧拉角转换为四元数；thrust表示的是当前姿态的z轴方向的归一化推力大小

#### 速度控制
- 订阅 查询机体局部坐标系速度
**话题：**`/mavros/local_position/velocity_local`
**消息：**`geometry_msgs/TwistStamped`
```CPP
ros::Subscriber vel_sub = nh.subscribe<geometry_msgs::TwistStamped>(
    "mavros/local_position/velocity_local", 10,
    [](const geometry_msgs::TwistStamped::ConstPtr& msg){
        ROS_INFO("Vx=%.2f Vy=%.2f Vz=%.2f",
                 msg->twist.linear.x,
                 msg->twist.linear.y,
                 msg->twist.linear.z);
    });

```
坐标系是 **ENU**（x 前、y 左、z 上），与 `/mavros/local_position/pose` 一致。

- 发布
**话题：** `/mavros/setpoint_velocity/cmd_vel`  
**消息：** `geometry_msgs/TwistStamped`
```CPP
ros::Publisher vel_pub =
  nh.advertise<geometry_msgs::TwistStamped>("mavros/setpoint_velocity/cmd_vel", 10);

geometry_msgs::TwistStamped vs;
vs.header.stamp = ros::Time::now();

// 期望 1 m/s 向前、0.5 m/s 上升，偏航右转 20°/s
vs.twist.linear.x = 1.0;   // 前
vs.twist.linear.y = 0.0;   // 左为正
vs.twist.linear.z = 0.5;   // 上为正
vs.twist.angular.z = -20.0 * M_PI/180.0; // 右转为负（按 ENU 惯例）

vel_pub.publish(vs);

```


#### 服务
- `/mavros/set_mode` 切 `OFFBOARD`切换模式
- `/mavros/cmd/arming` 解锁

